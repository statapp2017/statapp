#install.packages("twitteR", dependencies = TRUE)
#install.packages("base64enc")
#install.packages("openssl")
#install.packages("koRpus")
#install.packages("taskscheduleR")

rm(list = ls())
library(taskscheduleR)
library(base64enc)
library(koRpus)
library(openssl)
library(stringr)
library(twitteR)
library(devtools)
library(rtweet)
library(httr)

#Connexion au serveur Twitter
consumer_key <- "omimBnQiiwuOgqUPYxC501p0O"
consumer_secret <- "AuFzlqP7OKXD2xKOG6jnf6hYLKWcIiNsIlsRHDNS1ochNJuCtt"
access_token <- "826780938382241793-jOjPTTDTiLg162tvswNueIue1WM7gDc"
access_secret <- "Znbbt4Tgy5QFjdpHlI7ZXDWzPZArf96ZoZi0pKz8bfkFg"
create_token(app = "Tweepy1A", consumer_key, consumer_secret)

# Recuperation tweets------------------------------------------------------------------------------
# Fonction de recuperation des tweets et reponses si possible pour un identifiant de type @Mon_AXA
recuperer <- function(identifier, insurance) {
  options(show.error.messages = TRUE)
  Uid <- getUser(identifier)$id
  tweets_df <- get_timeline(Uid, n = 1000)[, c(1:13)]
  tweets_df <- tweets_df[!is.na(tweets_df$reply_to_status_id), ]
  tweets_df$conv <- tweets_df$reply_to_screen_name
  for (i in 1:nrow(tweets_df)) {
    try({
      SID <- tweets_df$reply_to_status_id[i]
      options(show.error.messages = FALSE)
      identifiant <- getUser(tweets_df$reply_to_user_id[i])
      t <- get_timeline(identifiant, n = 100)
      t$conv <- c(tweets_df$reply_to_screen_name[i])
      t <- t[t$status_id == SID, ]
      tweets_df <- rbind(tweets_df, t)
    })
  }
  tweets_df$assurance <- rep(insurance,nrow(tweets_df))
  tweets_df[order(tweets_df$conv), ]
}

warnings()

# liste_assu <- read.csv2("C:/Users/AC-te/Downloads/workspace/liste_assu.csv") #A
liste_assu <- read.csv2("/Users/okabeshu/Documents/ENSAE/StatApp/liste_assu.csv") #S
h <- recuperer(liste_assu$Identificateur[1], liste_assu$Assurance[1])

# Extraction pour toutes les assurances reperees --------------------------------------------------
extraction <- function(liste_assu, ancien_fichier) {
  ancien <- read.csv2(ancien_fichier)
  options(show.error.messages = TRUE)
  for (i in c(1:nrow(liste_assu))) {
    nouveau <- recuperer(liste_assu$Identificateur[i], liste_assu$Assurance[i])
    ancien <- rbind(ancien, nouveau)
    Sys.sleep(500)
  }
  ancien <- ancien[!duplicated(ancien$status_id), ]
  write.csv2(ancien, ancien_fichier, row.names = FALSE)
}

#extraction(liste_assu, "Assurances3.csv") #A
extraction(liste_assu, "/Users/okabeshu/Documents/ENSAE/StatApp/Assurances3.csv") #S

assurances <- read.csv2("/Users/okabeshu/Documents/ENSAE/StatApp/Assurances3.csv") #S

#Sauvegarde
#saveRDS(h, "/Users/okabeshu/Documents/ENSAE/StatApp/Sauvegarde.rds")
#data <- readRDS("/Users/okabeshu/Documents/ENSAE/StatApp/Sauvegarde.rds")

#assu <- read.csv("Assurances.csv") #A
assu <- read.csv("/Users/okabeshu/Documents/ENSAE/StatApp/Assurances.csv") #S
